<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>インボイス画像判定（OCR×要件チェック）</title>
<meta name="theme-color" content="#0f172a"/>
<style>
  :root{
    --ink:#0f172a; --muted:#475569; --ok:#16a34a; --warn:#d97706; --bad:#dc2626; --bg:#f8fafc; --card:#ffffff; --accent:#0ea5e9;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif}
  header{padding:16px 20px;background:#0f172a;color:#fff}
  header h1{margin:0;font-size:18px}
  main{max-width:1000px;margin:24px auto;padding:0 16px 64px}
  .card{background:var(--card);border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,.07);padding:18px;margin:12px 0}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start}
  .grow{flex:1 1 320px}
  label.button{display:inline-block;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  input[type=file]{display:none}
  .thumb{max-width:100%;border:1px solid #e2e8f0;border-radius:8px}
  .progress{height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:var(--accent);transition:width .2s}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;white-space:pre-wrap}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
  .ok{background:#dcfce7;color:#14532d}
  .bad{background:#fee2e2;color:#7f1d1d}
  .warn{background:#fef3c7;color:#78350f}
  ul.chk{list-style:none;padding-left:0}
  ul.chk li{padding:6px 8px;margin:6px 0;border:1px solid #e2e8f0;border-radius:8px}
  .li-ok{border-color:#86efac;background:#f0fdf4}
  .li-bad{border-color:#fecaca;background:#fff1f2}
  .li-warn{border-color:#fde68a;background:#fffbeb}
  details summary{cursor:pointer;color:#0e7490}
  .small{font-size:12px;color:var(--muted)}
  .right{float:right}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.grid2{grid-template-columns:1fr}}
  .link{color:#0369a1;text-decoration:underline}
</style>
</head>
<body>
<header><h1>インボイス画像判定（OCR×要件チェック：ローカル実行）</h1></header>
<main>
  <section class="card">
    <div class="row">
      <div class="grow">
        <p><strong>画像を選択/撮影</strong>（領収書・請求書等）：</p>
        <label class="button">
          画像を選ぶ/撮影<input id="file" type="file" accept="image/*" capture="environment">
        </label>
        <button id="sample" type="button">サンプルOCRテキストを読み込む</button>
        <button id="settings" type="button">API設定（任意）</button>
        <p class="small">※処理は端末内のみ。アップロードはしません。</p>
        <div class="progress" aria-label="OCR進捗" style="margin-top:10px"><div id="bar" class="bar"></div></div>
        <p id="status" class="small mono" style="min-height:1.2em"></p>
      </div>
      <div style="max-width:320px">
        <img id="preview" class="thumb" alt="プレビュー" />
      </div>
    </div>
  </section>

  <section class="card grid2">
    <div>
      <h3>判定結果 <span id="finalBadge" class="pill warn">未実行</span></h3>
      <div id="summary" class="mono small">画像を読み込むと自動でOCR→判定します。</div>
      <p class="small">※<strong>簡易インボイス</strong>の可能性も自動判定します（宛名省略可／税率or税額どちらか一方でも可）。</p>
      <div id="ntaLinkWrap" class="small"></div>
    </div>
    <div>
      <h3>抽出テキスト</h3>
      <textarea id="raw" class="mono" style="width:100%;height:200px"></textarea>
      <div style="margin-top:6px">
        <button id="recheck" type="button">このテキストで再判定</button>
        <button id="copy" type="button">テキストをコピー</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h3>要件チェック一覧（適格請求書の6要件）</h3>
    <ul id="checklist" class="chk"></ul>
    <details>
      <summary>検出した候補値を見る（T番号/日付/金額/語句など）</summary>
      <div id="candidates" class="mono small"></div>
    </details>
  </section>

  <section class="card small">
    <h3>注意・免責</h3>
    <ul>
      <li>OCRの性質上、<strong>誤認識・欠落</strong>があり得ます。最終判断は原本に基づく目視確認をお願いします。</li>
      <li>登録番号の<strong>オンライン照合</strong>は、国税庁インボイスWeb-APIの<strong>アプリケーションID</strong>を設定した場合のみ実施します（未設定でも要件判定は可能）。</li>
      <li>「このサービスは、国税庁適格請求書発行事業者公表システムのWeb-API機能を利用して取得した情報をもとに作成しているが、サービスの内容は国税庁によって保証されたものではない」。 [oai_citation:0‡納税通帳](https://www.invoice-kohyo.nta.go.jp/web-api/index.html)</li>
    </ul>
  </section>

  <dialog id="dlg">
    <form method="dialog" style="max-width:560px">
      <h3>API設定（任意）</h3>
      <p class="small">登録番号のオンライン照合に利用します。未設定でもオフライン判定は可能です。</p>
      <label>インボイスWeb-API アプリケーションID<br>
        <input id="appid" type="text" style="width:100%" placeholder="（例）ABCD-1234-...">
      </label>
      <div style="margin-top:10px"><button value="ok">保存</button> <button value="cancel">閉じる</button></div>
      <p class="small">※インボイスWeb-APIの利用にはアプリケーションIDの取得が必要です。 [oai_citation:1‡納税通帳](https://www.invoice-kohyo.nta.go.jp/web-api/index.html)</p>
    </form>
  </dialog>
</main>

<!-- Tesseract.js（ブラウザOCR） -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
const el = s => document.querySelector(s);
const file = el('#file'), img = el('#preview'), bar = el('#bar'), status = el('#status');
const raw = el('#raw'), summary = el('#summary'), badge = el('#finalBadge');
const checklistUL = el('#checklist'), candidatesDiv = el('#candidates');
const dlg = el('#dlg'), appidInput = el('#appid'); let APP_ID = localStorage.getItem('nta_appid')||'';
if(APP_ID) appidInput.value = APP_ID;

function setBadge(kind,text){
  badge.className = 'pill ' + (kind==='ok'?'ok':kind==='bad'?'bad':'warn');
  badge.textContent = text;
}
function setProgress(p){ bar.style.width = Math.max(0, Math.min(100, p*100)) + '%'; }

function loadImage(file){
  return new Promise((res)=>{ const fr = new FileReader();
    fr.onload = e => { img.src = e.target.result; res(); };
    fr.readAsDataURL(file);
  });
}

async function doOCRFromImage(){
  if(!img.src){ return; }
  status.textContent = 'OCR中…'; setProgress(0.05);
  const { createWorker } = Tesseract;
  const worker = await createWorker('jpn+eng', 1, {
    logger: m => { if(m.status==='recognizing text' && m.progress){ setProgress(0.1+0.9*m.progress); } }
  });
  const ret = await worker.recognize(img);
  await worker.terminate();
  raw.value = (ret.data && ret.data.text) ? ret.data.text : '';
  setProgress(1);
  status.textContent = 'OCR完了'; 
  runChecks();
}

function getMatches(regex, text){ const out=[]; let m; while((m=regex.exec(text))!==null){ out.push(m[0]); } return out; }
function yen2num(s){ return Number((s||'').replace(/[^\d.-]/g,'')); }

function runChecks(){
  const text = (raw.value||'').replace(/[ \t]+/g,' ').replace(/\r/g,'').trim();
  if(!text){ summary.textContent = 'テキストがありません。'; setBadge('warn','未判定'); checklistUL.innerHTML=''; candidatesDiv.textContent=''; return; }

  // 正規表現・語句
  const tNumberRe = /\bT[\s\-‐-–—]?(\d{13})\b/ig;
  const ymdRe = /((20\d{2}|19\d{2})[\/\-\.年]\s*\d{1,2}[\/\-\.月]\s*\d{1,2}日?)/g; // 西暦
  const eraRe = /(令和[元\d]+年\s*\d{1,2}月\s*\d{1,2}日)/g; // 和暦
  const rateWord = /(税率|適用税率|10 ?%|８ ?%|8 ?%|軽減|標準)/ig;
  const vatWord = /(消費税額|消費税等|税額)/ig;
  const receiverWord = /(御中|様|請求先|宛先|納品先)/g;
  const issuerHint = /(株式会社|合同会社|有限会社|商事|工業|店|○○|㈱)/g; // 参考程度
  const contentWord = /(品名|品目|数量|単価|役務|内容|摘要|商品|サービス)/g;

  const yenLineRe = /((合計|計|税込|税抜|小計)[^0-9\n]{0,10}[\-¥￥]?\s?\d{1,3}(?:,\d{3})*(?:\.\d+)?\s*円?)/g;

  const tNums = getMatches(tNumberRe, text);
  const dates = [...new Set(getMatches(ymdRe, text).concat(getMatches(eraRe, text)))];
  const rates = getMatches(rateWord, text);
  const vats = getMatches(vatWord, text);
  const receivers = getMatches(receiverWord, text);
  const issuers = getMatches(issuerHint, text);
  const contents = getMatches(contentWord, text);
  const totals = getMatches(yenLineRe, text);

  // 要件（適格請求書の6要件）
  const req = {
    regnum: { ok: tNums.length>0, label:'① 発行者の氏名/名称＋登録番号（T＋13桁）', found: tNums.join(', ')||'-' },
    date:   { ok: dates.length>0, label:'② 取引年月日', found: dates.slice(0,3).join(' / ')||'-' },
    detail: { ok: contents.length>0, label:'③ 取引内容（軽減対象の旨を含み得る）', found: contents.slice(0,6).join('、')||'-' },
    total:  { ok: (totals.length>0 && rates.length>0), label:'④ 税率ごとに合計した対価額（税抜/税込）＋適用税率', found: (rates.slice(0,4).join('、')||'-') + '｜' + (totals.slice(0,4).join(' / ')||'-') },
    tax:    { ok: vats.length>0, label:'⑤ 税率ごとの消費税額等', found: vats.slice(0,4).join('、')||'-' },
    recv:   { ok: receivers.length>0, label:'⑥ 交付を受ける事業者の氏名/名称（宛名等）', found: receivers.slice(0,4).join('、')||'-' },
  };

  // 簡易インボイスの可能性（宛名不要／税率 or 税額の一方で可）
  const simplePossible = req.regnum.ok && req.date.ok && req.detail.ok && (req.total.ok || req.tax.ok);

  // 適格請求書の最終判定（厳格）
  const allOk = Object.values(req).every(v => v.ok);

  // サマリー
  let verdict, kind;
  if(allOk){ verdict = '◎ 適格請求書（インボイス）の可能性が高い（6要件を満たしています）'; kind='ok'; }
  else if(simplePossible){ verdict = '◯ 簡易インボイス（適格簡易請求書）の可能性あり（宛名なし等でも法令上OKな場合があります）'; kind='warn'; }
  else { verdict = '× インボイス要件を満たさない可能性が高い（不足項目あり）'; kind='bad'; }
  setBadge(kind, kind==='ok'?'OK':kind==='warn'?'要確認':'不足');

  summary.innerHTML =
    `<div>${verdict}</div>
     <ul class="small">
       <li>登録番号検出: <strong>${tNums[0]||'未検出'}</strong></li>
       <li>取引日候補: ${req.date.found}</li>
       <li>税率/合計/消費税語句: ${rates.length}/${totals.length}/${vats.length}</li>
     </ul>`;

  // NTA検索リンク
  const nt = el('#ntaLinkWrap');
  if(tNums[0]){
    const clean = tNums[0].replace(/\s|[\-‐-–—]/g,'');
    nt.innerHTML = `登録番号の公表サイト検索リンク：<a class="link" target="_blank" 
      href="https://www.invoice-kohyo.nta.go.jp/index.html?sel=number&number=${encodeURIComponent(clean)}">国税庁・登録番号検索</a>`;
  } else { nt.innerHTML = ''; }

  // チェックリスト表示
  checklistUL.innerHTML = '';
  Object.values(req).forEach(v=>{
    const li = document.createElement('li');
    li.className = v.ok ? 'li-ok' : 'li-bad';
    li.innerHTML = (v.ok? '✅ ':'❌ ') + v.label + `<span class="right">${v.ok?'OK':'不足'}</span><br><span class="small">ヒット：${v.found}</span>`;
    checklistUL.appendChild(li);
  });

  // 参考候補のダンプ
  candidatesDiv.textContent =
    '登録番号候補: ' + (tNums.join(', ')||'-') + '\n' +
    '日付候補: ' + (dates.join(' / ')||'-') + '\n' +
    '税率語句: ' + (rates.join(', ')||'-') + '\n' +
    '消費税語句: ' + (vats.join(', ')||'-') + '\n' +
    '宛名語句: ' + (receivers.join(', ')||'-') + '\n' +
    '取引内容語句: ' + (contents.join(', ')||'-') + '\n' +
    '金額行候補: ' + (totals.join(' / ')||'-') + '\n';

  // 任意：登録番号のWeb-API照合（APP_IDが設定されている場合のみ）
  if(APP_ID && tNums[0]){
    verifyTNumber(tNums[0].replace(/\s|[\-‐-–—]/g,''), APP_ID).then(info=>{
      if(info && info.hit){
        summary.innerHTML += `<div class="small">Web-API照合：<span class="pill ok">有効な登録番号の可能性</span> 名称：${escapeHtml(info.name||'')}</div>`;
      }else{
        summary.innerHTML += `<div class="small">Web-API照合：<span class="pill bad">ヒットせず/要確認</span></div>`;
      }
    }).catch(()=>{ summary.innerHTML += `<div class="small">Web-API照合：<span class="pill warn">エラー（後で再試行）</span></div>`; });
  }
}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

// ★ 簡易なWeb-API呼び出し（仕様上、アプリケーションIDが必要／CORS制約あり得ます）
// 仕様は国税庁ページの「Web-APIの詳細」を参照。ここでは代表的なエンドポイント例に合わせています。
async function verifyTNumber(tnum, appId){
  try{
    // 代表的な仕様例：GET /web-api/num?number=Txxxxxxxxxxxxx&appId=...（実際のパスは仕様書に従ってください）
    // ここでは「検証用」のダミー実装にし、実運用時は仕様書に合わせてURL/クエリ/ヘッダを修正してください。
    const url = `https://www.invoice-kohyo.nta.go.jp/web-api/num?number=${encodeURIComponent(tnum)}&appId=${encodeURIComponent(appId)}`;
    const res = await fetch(url, {mode:'cors'});
    if(!res.ok){ return null; }
    const data = await res.json().catch(()=>null);
    if(!data){ return null; }
    // 想定フォーマット例に合わせて読み替え
    return { hit: !!(data.number || data.items && data.items.length), name: data.name || (data.items && data.items[0] && data.items[0].name) };
  }catch(e){ return null; }
}

el('#sample').addEventListener('click', ()=>{
  raw.value =
`請求書（見本）
T 1234567890123
株式会社テスト商事
請求先：〇〇株式会社 御中
取引日：2025年10月1日
品目：備品A　数量1　単価10,000
10%対象 合計 10,000円
消費税額 1,000円
税込合計 11,000円`;
  runChecks();
});

file.addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  await loadImage(f);
  setProgress(0); status.textContent='画像読込';
  setTimeout(()=>{ doOCRFromImage(); }, 100);
});

el('#recheck').addEventListener('click', runChecks);
el('#copy').addEventListener('click', async()=>{ await navigator.clipboard.writeText(raw.value||''); });

el('#settings').addEventListener('click', ()=>{ dlg.showModal(); });
dlg.addEventListener('close', ()=>{
  if(dlg.returnValue==='ok'){
    APP_ID = (appidInput.value||'').trim();
    localStorage.setItem('nta_appid', APP_ID);
    runChecks();
  }
});
</script>
</body>
</html>