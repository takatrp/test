<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>写真→買取相場（r1）</title>
<meta name="theme-color" content="#1f2937"/>
<style>
  :root{
    --bg:#f7fafc;--ink:#0f172a;--muted:#64748b;--card:#ffffff;--accent:#1f6feb;--ok:#16a34a;--warn:#f59e0b;--danger:#dc2626;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif;}
  header{position:sticky;top:0;z-index:10;background:#111827;color:#fff;padding:12px 16px;box-shadow:0 2px 10px rgba(0,0,0,.1);}
  header h1{font-size:18px;margin:0;}
  main{max-width:1100px;margin:20px auto;padding:0 16px;}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px;}
  .card h2{font-size:16px;margin:0 0 8px 0}
  .sub{color:var(--muted);font-size:12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:10px;background:var(--accent);color:#fff;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#334155}
  .btn.ghost{background:transparent;color:var(--accent);border:2px solid var(--accent)}
  .btn.warn{background:var(--warn);}
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  input[type="file"]{display:none}
  .filelabel{display:inline-flex;gap:8px;align-items:center;border:2px dashed #cbd5e1;border-radius:14px;padding:14px 16px;background:#fff;cursor:pointer}
  .kvs{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:700px){.kvs{grid-template-columns:1fr}}
  .kv{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:10px}
  .kv .name{font-size:12px;color:#475569}
  .kv .val{font-weight:700}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;border-radius:999px;padding:6px 10px;font-size:12px}
  .list{display:grid;gap:10px}
  .item{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid #e5e7eb;border-radius:12px}
  .item img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb}
  .flex{display:flex;align-items:center;gap:8px}
  .right{margin-left:auto}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .danger{color:var(--danger)}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .hr{height:1px;background:#e5e7eb;margin:8px 0}
  .footer{margin:40px 0 20px;color:#6b7280;font-size:12px;text-align:center}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:#e5e7eb;color:#111827;border-radius:999px;padding:4px 10px;font-size:12px}
  .dangerbox{background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:10px}
  .okbox{background:#ecfdf5;border:1px solid #bbf7d0;border-radius:12px;padding:10px}
  details > summary{cursor:pointer;font-weight:700}
  code.inline{background:#111827;color:#fff;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<header>
  <h1>写真→買取相場（r1・PWAモック）</h1>
</header>
<main>
  <div class="grid">
    <!-- 左：撮影〜同定〜相場 -->
    <section class="card">
      <h2>1. 撮影→同定</h2>
      <p class="sub">スマホで撮影（EXIF除去＆リサイズ）、型番/ブランド候補を自動抽出します。※r1はデモ同定</p>
      <div class="row">
        <label class="filelabel" for="file">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
          写真を選択/撮影（背面カメラ推奨）
        </label>
        <input id="file" type="file" accept="image/*;capture=camera" />
        <button class="btn secondary" id="retake" disabled>画像をクリア</button>
        <span class="pill" id="imginfo">未選択</span>
      </div>
      <div class="hr"></div>
      <canvas id="preview" style="width:100%;max-height:360px;background:#0b1020;border-radius:12px"></canvas>
      <div class="hr"></div>
      <div class="kvs">
        <div class="kv"><div class="name">候補キーワード</div><div class="val" id="kw">-</div></div>
        <div class="kv"><div class="name">確度</div><div class="val" id="score">-</div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="runIdentify" disabled>候補を抽出</button>
        <div class="muted small">※r1はローカルで擬似推論（実装時はサーバ側でモデル推論）</div>
      </div>
    </section>

    <!-- 右：調整・結果 -->
    <section class="card">
      <h2>2. 原価・粗利パラメータ</h2>
      <div class="list">
        <label>販売手数料（%）<br><input type="number" id="fee" value="10" min="0" max="50" step="0.1" style="width:120px"> </label>
        <label>想定送料（円）<br><input type="number" id="ship" value="800" min="0" step="1" style="width:120px"> </label>
        <label>整備・クリーニング（円）<br><input type="number" id="refurb" value="1000" min="0" step="1" style="width:120px"> </label>
        <label>返品・不良率（%）<br><input type="number" id="rr" value="3" min="0" max="30" step="0.1" style="width:120px"> </label>
        <label>目標粗利率（%）<br><input type="number" id="gm" value="25" min="0" max="80" step="0.1" style="width:120px"> </label>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn ok" id="calc" disabled>推奨買取上限を計算</button>
        <span id="calcstatus" class="muted small">相場取得後に有効</span>
      </div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h2>3. 相場（Aucfan + Yahoo + eBay 集約）</h2>
    <div class="row">
      <button class="btn" id="fetchMarket" disabled>相場を取得</button>
      <label class="flex small"><input type="checkbox" id="demo" checked /> デモデータで試す</label>
      <span class="right small muted">API接続は下の「設定」から</span>
    </div>
    <div class="kvs" style="margin-top:10px">
      <div class="kv"><div class="name">件数（採用）</div><div class="val" id="n">-</div></div>
      <div class="kv"><div class="name">中央値</div><div class="val" id="p50">-</div></div>
      <div class="kv"><div class="name">第1四分位（Q1）</div><div class="val" id="q1">-</div></div>
      <div class="kv"><div class="name">第3四分位（Q3）</div><div class="val" id="q3">-</div></div>
    </div>
    <div class="hr"></div>
    <div class="list" id="items"></div>
  </section>

  <section class="card">
    <h2>4. 推奨買取上限レンジ</h2>
    <div id="suggest" class="okbox">
      <div class="row"><strong>未計算</strong><span class="small muted">（相場取得→計算）</span></div>
    </div>
    <p class="small muted">式：<code class="inline">買取上限 ≒ 販売予想価格 × (1 - 手数料% - 返品率%) − 送料 − 整備費 − 目標粗利率×販売予想価格</code></p>
  </section>

  <section class="card">
    <h2>5. 監査ログ・保存</h2>
    <div class="row">
      <button class="btn ghost" id="save">案件を保存（JSON）</button>
      <button class="btn ghost" id="csv">CSV書き出し</button>
      <button class="btn ghost" id="print">印刷（PDF可）</button>
    </div>
    <pre id="audit" class="mono small" style="white-space:pre-wrap"></pre>
  </section>

  <section class="card">
    <h2>設定（API接続）</h2>
    <div class="list">
      <label>バックエンドURL（例：<code class="inline">https://your-domain/api</code>）<br>
        <input id="apiBase" placeholder="/api" value="/api" style="width:320px">
      </label>
      <div class="chips">
        <span class="chip">Aucfan: /market/aucfan</span>
        <span class="chip">Yahoo: /market/yahoo</span>
        <span class="chip">eBay: /market/ebay</span>
        <span class="chip">同定: /identify</span>
      </div>
      <p class="small muted">※APIキーはフロントに置かず、サーバ側で保管してください。</p>
    </div>
  </section>

  <div class="footer">
    © <span id="year"></span> 買取査定モック r1｜内部検証用。実運用前に各プラットフォーム規約・法令順守を確認してください。
  </div>
</main>
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const state = {img:null, imgW:0, imgH:0, kw:null, score:null, items:[], stats:null};
  const canvas = $('preview');
  const ctx = canvas.getContext('2d');
  $('year').textContent = new Date().getFullYear();

  function drawImage(file){
    const img = new Image();
    img.onload = ()=>{
      // resize to max 1600px longest
      const max = 1600; const ratio = Math.min(max/img.width, max/img.height, 1);
      const w = Math.round(img.width * ratio), h = Math.round(img.height * ratio);
      canvas.width = w; canvas.height = h; ctx.drawImage(img,0,0,w,h);
      state.img = canvas.toDataURL('image/jpeg', .8);
      state.imgW = w; state.imgH = h;
      $('imginfo').textContent = `${w}×${h}`;
      $('runIdentify').disabled = false;
      $('retake').disabled = false;
      $('fetchMarket').disabled = false;
    };
    const reader = new FileReader();
    reader.onload = e=>{img.src = e.target.result};
    reader.readAsDataURL(file);
  }

  $('file').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return; drawImage(f);
  });
  $('retake').addEventListener('click', ()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    $('file').value = '';
    state.img = null; $('imginfo').textContent = '未選択';
    $('kw').textContent='-'; $('score').textContent='-';
    $('items').innerHTML=''; $('n').textContent='-'; $('p50').textContent='-'; $('q1').textContent='-'; $('q3').textContent='-';
    $('runIdentify').disabled = true; $('fetchMarket').disabled = true; $('calc').disabled = true; $('calcstatus').textContent = '相場取得後に有効';
  });

  // r1: demo identify (サーバ実装時は /identify にPOST)
  $('runIdentify').addEventListener('click', async()=>{
    if (!$('demo').checked) {
      try {
        const res = await fetch(($('apiBase').value||'/api') + '/identify', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({image: state.img})});
        const j = await res.json();
        state.kw = j.keyword; state.score = j.score || 0.7;
      } catch(e){console.warn(e); demoIdentify();}
    } else { demoIdentify(); }
    $('kw').textContent = state.kw; $('score').textContent = (state.score*100).toFixed(0)+'%';
  });

  function demoIdentify(){
    // 画像内容に依らずサンプル
    const samples = [
      {kw:'Canon IXY 650 デジカメ', s:0.78},
      {kw:'LOUIS VUITTON 長財布 モノグラム', s:0.73},
      {kw:'Nintendo Switch Joy-Con (L/R) レッド', s:0.69},
      {kw:'SEIKO 腕時計 5 Sports SRPD', s:0.66}
    ];
    const pick = samples[Math.floor(Math.random()*samples.length)];
    state.kw = pick.kw; state.score = pick.s;
  }

  $('fetchMarket').addEventListener('click', async()=>{
    if(!state.kw){alert('先に候補抽出を実行してください'); return;}
    $('items').innerHTML = '<span class="muted">取得中…</span>';
    let merged = [];
    if ($('demo').checked){
      merged = demoMarket(state.kw);
    } else {
      try{
        const base = $('apiBase').value || '/api';
        const [auc, yah, ebay] = await Promise.all([
          fetch(base + '/market/aucfan', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({q:state.kw})}).then(r=>r.json()).catch(()=>[]),
          fetch(base + '/market/yahoo', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({q:state.kw})}).then(r=>r.json()).catch(()=>[]),
          fetch(base + '/market/ebay', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({q:state.kw, image: state.img})}).then(r=>r.json()).catch(()=>[])
        ]);
        merged = [...auc, ...yah, ...ebay];
      }catch(e){ console.warn(e); merged = demoMarket(state.kw); }
    }
    // 正規化＆外れ値除去
    const prices = merged.map(x=>x.price).filter(x=>Number.isFinite(x) && x>0).sort((a,b)=>a-b);
    const n = prices.length;
    if(n<3){ $('items').innerHTML = '<div class="dangerbox small">採用できる比較対象が不足しました（n<3）。キーワード修正を検討してください。</div>'; $('n').textContent=n; return; }
    const q1 = quantile(prices, 0.25), q3 = quantile(prices, 0.75), iqr = q3 - q1;
    const lo = q1 - 1.5*iqr, hi = q3 + 1.5*iqr;
    const filtered = merged.filter(x=>x.price>=lo && x.price<=hi);
    const fp = filtered.map(x=>x.price).sort((a,b)=>a-b);
    const stats = {n:fp.length, p50: quantile(fp,0.5), q1: quantile(fp,0.25), q3: quantile(fp,0.75)};
    state.items = filtered; state.stats = stats;
    $('n').textContent = stats.n; $('p50').textContent = yen(stats.p50); $('q1').textContent = yen(stats.q1); $('q3').textContent = yen(stats.q3);
    $('items').innerHTML = '';
    filtered.slice(0,25).forEach(it=>{
      const div = document.createElement('div');
      div.className='item';
      div.innerHTML = `<img src="${it.thumb||''}" alt="thumb"><div><div><strong>${esc(it.title||'商品')}</strong></div><div class="small muted">${it.source||''}｜${it.date||''}</div><div class="small">${yen(it.price)}　<a href="${it.url}" target="_blank" rel="noopener">根拠</a></div></div>`;
      $('items').appendChild(div);
    });
    $('calc').disabled = false; $('calcstatus').textContent = 'OK';
  });

  $('calc').addEventListener('click', ()=>{
    if(!state.stats){alert('相場を取得してください');return;}
    const fee = parseFloat($('fee').value||0)/100;
    const ship = parseFloat($('ship').value||0);
    const refurb = parseFloat($('refurb').value||0);
    const rr = parseFloat($('rr').value||0)/100;
    const gm = parseFloat($('gm').value||0)/100;
    const sale = state.stats.p50; // 予想販売価格＝中央値
    const net = sale * (1 - fee - rr) - ship - refurb;
    const cap = Math.max(0, net - sale*gm);
    const low = Math.round(cap*0.95), hi = Math.round(cap*1.05);
    $('suggest').innerHTML = `<div class="row"><strong>推奨買取上限：</strong><span class="pill">${yen(low)}〜${yen(hi)}</span><span class="small muted">（中央値：${yen(sale)} / fee:${(fee*100).toFixed(1)}% rr:${(rr*100).toFixed(1)}% gm:${(gm*100).toFixed(1)}%）</span></div>`;
    // 監査ログ
    const audit = {
      ts: new Date().toISOString(),
      image:{w:state.imgW,h:state.imgH},
      identify:{keyword:state.kw,score:state.score},
      market:{stats:state.stats, items: state.items.slice(0,50)},
      params:{fee,ship,refurb,rr,gm},
      suggestion:{low,high:hi,cap}
    };
    $('audit').textContent = JSON.stringify(audit,null,2);
  });

  $('save').addEventListener('click',()=>{
    const blob = new Blob([$('audit').textContent||'{}'],{type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `kaitori_audit_${Date.now()}.json`; a.click();
  });
  $('csv').addEventListener('click',()=>{
    if(!state.items?.length){alert('相場を取得してください');return;}
    const rows = [['source','title','price','date','url']].concat(state.items.map(x=>[x.source||'', safeCSV(x.title||''), x.price, x.date||'', x.url||'']));
    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `kaitori_items_${Date.now()}.csv`; a.click();
  });
  $('print').addEventListener('click',()=>window.print());

  function esc(s){return (s+'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
  function yen(v){return '¥'+(Math.round(v).toLocaleString());}
  function quantile(arr, q){
    const pos = (arr.length - 1) * q; const base = Math.floor(pos), rest = pos - base;
    if(arr[base+1]!==undefined) return arr[base] + rest * (arr[base+1]-arr[base]);
    return arr[base];
  }
  function safeCSV(s){return '"'+(s.replace(/"/g,'""'))+'"';}

  function demoMarket(q){
    const base = Math.floor(5000+Math.random()*30000);
    const mk = (source, f)=>({source, title:q+' '+f.title, price: Math.max(500, Math.round(base*(.8+Math.random()*0.4))), date: new Date(Date.now()-Math.random()*86400000*30).toISOString().slice(0,10), url:'#', thumb:'',});
    const a = Array.from({length:10},(_,i)=>mk('Aucfan',{title:`落札履歴#${i+1}`}));
    const y = Array.from({length:8},(_,i)=>mk('Yahoo Shopping',{title:`在庫#${i+1}`}));
    const e = Array.from({length:10},(_,i)=>mk('eBay',{title:`Item#${i+1}`}));
    return [...a,...y,...e];
  }
})();
</script>
</body>
</html>
