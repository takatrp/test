<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Respectful Dating Coach (MVP)</title>
  <style>
    :root { --bg:#0b0f14; --card:#111826; --text:#e8eef7; --muted:#9fb0c5; --line:#263246; --accent:#5aa7ff; --warn:#ffcc66; --bad:#ff6b6b; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:20px;}
    h1{font-size:20px;margin:0 0 6px;}
    .sub{color:var(--muted);font-size:13px;line-height:1.5;margin-bottom:16px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:8px 10px;color:var(--muted);font-size:13px;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    button{background:#162238;border:1px solid var(--line);color:var(--text);border-radius:12px;padding:10px 12px;cursor:pointer;}
    button.primary{background:var(--accent);border-color:transparent;color:#08111f;font-weight:700;}
    button:disabled{opacity:.55;cursor:not-allowed;}
    textarea,input,select{width:100%;box-sizing:border-box;background:#0c1422;border:1px solid var(--line);border-radius:12px;color:var(--text);padding:10px;font-size:14px;}
    textarea{min-height:140px;resize:vertical;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:860px){.grid{grid-template-columns:1fr;}}
    .hint{color:var(--muted);font-size:12px;line-height:1.5;margin-top:6px;}
    .warn{color:var(--warn);font-size:12px;line-height:1.5;}
    .bad{color:var(--bad);font-size:12px;line-height:1.5;}
    pre{white-space:pre-wrap;background:#0a1220;border:1px solid var(--line);border-radius:12px;padding:10px;margin:0;font-size:13px;line-height:1.55;}
    .small{font-size:12px;color:var(--muted);}
    .hr{height:1px;background:var(--line);margin:10px 0;}
    .hidden{display:none;}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Respectful Dating Coach (MVP)</h1>
  <div class="sub">
    目的：自己整理・丁寧なコミュニケーション・関係構築の練習。<br>
    注意：相手の氏名/住所/電話/メール/勤務先など個人特定情報は入力しないでください。入力文はAIに送信されます（保存しない設計ですが、AI提供者側の保持が発生し得ます）。:contentReference[oaicite:4]{index=4}
  </div>

  <div class="card">
    <div class="row">
      <label class="pill"><input id="age" type="checkbox"> 18歳以上です（推奨）</label>
      <label class="pill"><input id="consent" type="checkbox"> 入力文をAIに送信することに同意</label>
      <label class="pill"><input id="mask" type="checkbox" checked> 簡易マスキング（推奨）</label>
      <span class="pill">モード:
        <select id="tone" style="width:auto;padding:6px 10px;border-radius:999px;">
          <option value="polite">丁寧</option>
          <option value="casual">カジュアル</option>
          <option value="short">短め</option>
        </select>
      </span>
    </div>
    <div class="hint">
      同意は「目的を具体的に示して得る」必要があります（抽象的説明は避ける）。:contentReference[oaicite:5]{index=5}
    </div>
    <div id="gateMsg" class="warn"></div>
  </div>

  <div class="tabs">
    <button id="tabMsg" class="primary" onclick="setTab('msg')">メッセージ添削</button>
    <button id="tabProf" onclick="setTab('prof')">プロフィール作成</button>
    <button id="tabRole" onclick="setTab('role')">会話練習</button>
  </div>

  <!-- Message Coach -->
  <div id="panelMsg" class="card">
    <h2 style="font-size:16px;margin:0 0 10px;">メッセージ添削（返信案 + リスク注意）</h2>
    <div class="grid">
      <div>
        <label>相手からのメッセージ（個人特定情報は入力しない）</label>
        <textarea id="inFrom" placeholder="例：今日はありがとう！また会えたら嬉しいです。"></textarea>
        <div class="hint">固有名詞は「Aさん」「B店」等に置換してください。</div>
      </div>
      <div>
        <label>あなたが返したい内容（要旨）</label>
        <textarea id="inTo" placeholder="例：こちらこそ。来週のどこかでお茶できると嬉しい。"></textarea>
        <div class="hint">目的：誠実さ、安心感、次につながる提案。</div>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button onclick="run('msg')" id="btnMsg" class="primary">生成</button>
      <button onclick="copyOut('outMsg')">コピー</button>
      <button onclick="clearAll()">全消去</button>
    </div>
    <div class="hr"></div>
    <pre id="outMsg" aria-live="polite"></pre>
    <div class="small" style="margin-top:8px;">
      ※相手を騙す/操る/威圧する/性的に迫る等の依頼は拒否します。
    </div>
  </div>

  <!-- Profile Builder -->
  <div id="panelProf" class="card hidden">
    <h2 style="font-size:16px;margin:0 0 10px;">プロフィール作成（誠実・具体・過度な盛りなし）</h2>
    <div class="grid">
      <div>
        <label>あなたの要素（箇条書き）</label>
        <textarea id="profFacts" placeholder="例：休日はランニング/読書。仕事は営業。お酒は少なめ。相手の話を聞くのが好き。"></textarea>
        <div class="hint">「盛る」より「検証可能な具体」を優先。</div>
      </div>
      <div>
        <label>求める関係性/価値観（箇条書き）</label>
        <textarea id="profValues" placeholder="例：お互いの仕事を尊重。連絡頻度は無理しない。会う時は会話を大事にしたい。"></textarea>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button onclick="run('prof')" id="btnProf" class="primary">生成</button>
      <button onclick="copyOut('outProf')">コピー</button>
    </div>
    <div class="hr"></div>
    <pre id="outProf" aria-live="polite"></pre>
  </div>

  <!-- Roleplay -->
  <div id="panelRole" class="card hidden">
    <h2 style="font-size:16px;margin:0 0 10px;">会話練習（ロールプレイ）</h2>
    <div class="grid">
      <div>
        <label>シーン</label>
        <select id="scene">
          <option value="first_chat">マッチング後の初回チャット</option>
          <option value="first_date">初回デート（カフェ）</option>
          <option value="second_date">2回目の提案</option>
          <option value="boundary">境界線（断り方/配慮）</option>
        </select>
        <div class="hint">“相手の同意・安心感”を最優先に設計します。</div>
      </div>
      <div>
        <label>あなたの目標（1行）</label>
        <input id="goal" placeholder="例：相手の興味を聞き、次に会う提案を自然にする" />
        <div class="hint">拒否されたら引く、を前提に。</div>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button onclick="run('role')" id="btnRole" class="primary">開始</button>
      <button onclick="copyOut('outRole')">コピー</button>
    </div>
    <div class="hr"></div>
    <pre id="outRole" aria-live="polite"></pre>
  </div>

  <div class="card">
    <h2 style="font-size:14px;margin:0 0 8px;">実装メモ（公開配信する場合の注意）</h2>
    <div class="hint">
      ・アプリ配信で「Social/Dating」に該当する場合、子ども安全基準や申告が必要になり得ます。:contentReference[oaicite:6]{index=6}<br>
      ・App Store配信ではプライバシーやUGCモデレーション等のガイドライン遵守が前提です。:contentReference[oaicite:7]{index=7}
    </div>
  </div>
</div>

<script>
  const API_URL = "/api/coach"; // same-origin backend

  function setTab(tab){
    const map = {msg:["panelMsg","tabMsg"], prof:["panelProf","tabProf"], role:["panelRole","tabRole"]};
    for(const k of Object.keys(map)){
      document.getElementById(map[k][0]).classList.toggle("hidden", k!==tab);
      document.getElementById(map[k][1]).classList.toggle("primary", k===tab);
    }
  }

  function maskPII(text){
    // NOTE: 完全な匿名化ではありません（補助）。ユーザーには「入力しない」運用を推奨。
    return text
      .replace(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/g, "[EMAIL]")
      .replace(/(\+?\d[\d -]{8,}\d)/g, "[PHONE]")
      .replace(/(〒?\s*\d{3}-\d{4}|\d{1,3}-\d{1,4}-\d{4})/g, "[ID]");
  }

  function looksDisallowed(text){
    const t = (text||"").toLowerCase();
    const patterns = [
      /未成年|中学生|高校生|小学生|児童|18歳未満/,
      /レイプ|強姦|睡眠薬|媚薬|薬で/,
      /脅す|脅迫|恐喝|ストーカー|尾行|住所を突き止め/,
      /騙す|だます|嘘をつく|なりすます|成りすまし/,
      /エロ|性行為|セックス|裸|ハメる|風俗/
    ];
    return patterns.some(rx => rx.test(t));
  }

  function gateCheck(){
    const age = document.getElementById("age").checked;
    const consent = document.getElementById("consent").checked;
    const msg = document.getElementById("gateMsg");
    msg.textContent = "";
    if(!consent){
      msg.textContent = "AI送信の同意が必要です。";
      return false;
    }
    // 18+は必須にせず“推奨”にしておく（運用で必須にする場合は要件を確認）
    if(!age){
      msg.textContent = "18歳以上の利用を推奨します（公開配信する場合は年齢設計を検討）。";
    }
    return true;
  }

  async function run(mode){
    if(!gateCheck()) return;

    let payload = { mode, tone: document.getElementById("tone").value, mask: document.getElementById("mask").checked };

    if(mode==="msg"){
      payload.from = document.getElementById("inFrom").value.trim();
      payload.to = document.getElementById("inTo").value.trim();
      if(looksDisallowed(payload.from + "\n" + payload.to)){
        document.getElementById("outMsg").textContent = "この依頼は不適切な可能性があるため処理できません（欺罔・嫌がらせ・未成年・性的強要等）。";
        return;
      }
      if(payload.mask){ payload.from = maskPII(payload.from); payload.to = maskPII(payload.to); }
      setBusy("btnMsg", true);
      document.getElementById("outMsg").textContent = "生成中…";
    }

    if(mode==="prof"){
      payload.facts = document.getElementById("profFacts").value.trim();
      payload.values = document.getElementById("profValues").value.trim();
      if(looksDisallowed(payload.facts + "\n" + payload.values)){
        document.getElementById("outProf").textContent = "この依頼は不適切な可能性があるため処理できません。";
        return;
      }
      if(payload.mask){ payload.facts = maskPII(payload.facts); payload.values = maskPII(payload.values); }
      setBusy("btnProf", true);
      document.getElementById("outProf").textContent = "生成中…";
    }

    if(mode==="role"){
      payload.scene = document.getElementById("scene").value;
      payload.goal = document.getElementById("goal").value.trim();
      if(looksDisallowed(payload.goal)){
        document.getElementById("outRole").textContent = "この依頼は不適切な可能性があるため処理できません。";
        return;
      }
      if(payload.mask){ payload.goal = maskPII(payload.goal); }
      setBusy("btnRole", true);
      document.getElementById("outRole").textContent = "生成中…";
    }

    try{
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        cache: "no-store"
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || "Request failed");

      if(mode==="msg") document.getElementById("outMsg").textContent = data.text || "";
      if(mode==="prof") document.getElementById("outProf").textContent = data.text || "";
      if(mode==="role") document.getElementById("outRole").textContent = data.text || "";
    }catch(e){
      const outId = mode==="msg" ? "outMsg" : mode==="prof" ? "outProf" : "outRole";
      document.getElementById(outId).textContent = "エラー: " + e.message;
    }finally{
      setBusy(mode==="msg"?"btnMsg":mode==="prof"?"btnProf":"btnRole", false);
    }
  }

  function setBusy(btnId, busy){
    const b = document.getElementById(btnId);
    b.disabled = busy;
    b.textContent = busy ? "処理中…" : (btnId==="btnMsg"?"生成":btnId==="btnProf"?"生成":"開始");
  }

  function copyOut(id){
    const text = document.getElementById(id).textContent || "";
    navigator.clipboard.writeText(text);
  }

  function clearAll(){
    ["inFrom","inTo","outMsg","profFacts","profValues","outProf","goal","outRole"].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      if(el.tagName==="TEXTAREA" || el.tagName==="INPUT") el.value="";
      else el.textContent="";
    });
  }
</script>
</body>
</html>
