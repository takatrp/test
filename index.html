<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>三光ビル FXクラウド仕訳作成ツール（HTML版）</title>

<style>
  :root{
    --bg:#f4f9fb;
    --card:#ffffff;
    --ink:#1e2a2d;
    --muted:#5a6a6d;
    --accent:#578899;
    --accent-dark:#416b74;
    --border:#d1dde2;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:var(--ink);
  }
  .container{
    max-width:900px;
    margin:24px auto 40px;
    padding:0 16px;
  }
  h1{
    font-size:1.4rem;
    margin:0 0 4px;
  }
  .subtitle{
    margin:0 0 16px;
    color:var(--muted);
    font-size:.9rem;
  }
  .card{
    background:var(--card);
    border-radius:12px;
    box-shadow:0 8px 22px rgba(0,0,0,.06);
    padding:16px 18px 18px;
    margin-top:16px;
    border:1px solid var(--border);
  }
  .card h2{
    font-size:1rem;
    margin:0 0 8px;
  }
  .card p{
    margin:4px 0 10px;
    font-size:.9rem;
    color:var(--muted);
  }
  label{
    display:block;
    margin:8px 0;
    font-size:.9rem;
  }
  input[type="file"]{
    display:block;
    margin-top:4px;
    font-size:.85rem;
  }
  button{
    appearance:none;
    border:none;
    border-radius:999px;
    padding:10px 20px;
    font-size:.9rem;
    cursor:pointer;
    background:var(--accent);
    color:#fff;
    font-weight:600;
    margin-right:8px;
    transition:background .15s, transform .05s, box-shadow .15s;
    box-shadow:0 4px 12px rgba(87,136,153,.35);
  }
  button:hover:enabled{
    background:var(--accent-dark);
  }
  button:active:enabled{
    transform:translateY(1px);
    box-shadow:0 2px 8px rgba(87,136,153,.35);
  }
  button:disabled{
    opacity:.5;
    cursor:default;
    box-shadow:none;
  }
  .buttons{
    margin-top:8px;
  }
  #log{
    margin-top:8px;
    padding:10px 12px;
    background:#0b1220;
    color:#e5e7eb;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New", monospace;
    font-size:.8rem;
    border-radius:8px;
    max-height:260px;
    overflow:auto;
    white-space:pre-wrap;
  }
  .note{
    margin-top:12px;
    font-size:.8rem;
    color:var(--muted);
  }
</style>

<!-- SheetJS (xlsx) CDN -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <h1>三光ビル FXクラウド仕訳作成ツール（HTML版）</h1>
  <p class="subtitle">
    ①の「三光ビル賃貸料」シートから請求金額と請求日を読み取り、②のFXクラウド取込レイアウトに自動転記します。
  </p>

  <div class="card">
    <h2>1. ファイルを選択</h2>
    <p>同じ月の①・②のExcelファイルを指定してください。</p>
    <label>
      ① 請求書（入金管理表）ファイル（.xlsx）
      <input type="file" id="file1" accept=".xlsx" />
    </label>
    <label>
      ② FXクラウド取込テンプレート（.xlsx）
      <input type="file" id="file2" accept=".xlsx" />
    </label>
  </div>

  <div class="card">
    <h2>2. 変換の実行・ダウンロード</h2>
    <p>「変換を実行」→問題がなければ「結果をダウンロード」で更新済み②ファイルを保存できます。</p>
    <div class="buttons">
      <button id="runBtn">変換を実行</button>
      <button id="downloadBtn" disabled>結果をダウンロード（更新済み②）</button>
    </div>
    <pre id="log"></pre>
    <div class="note">
      前提：①のレイアウトは「号室＋請求金額（税込）」「≪請求日≫」が今回のサンプルと同じ位置、②はFXクラウドの標準取込レイアウトを想定しています。
      レイアウトを変更した場合は調整が必要です。
    </div>
  </div>
</div>

<script>
(function(){
  const file1Input = document.getElementById('file1');
  const file2Input = document.getElementById('file2');
  const runBtn = document.getElementById('runBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const logEl = document.getElementById('log');

  let resultWorkbook = null;

  function log(msg){
    const now = new Date().toISOString().replace('T',' ').slice(0,19);
    logEl.textContent += `[${now}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function clearLog(){
    logEl.textContent = '';
  }

  function loadWorkbook(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => {
        try{
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, {type:'array', cellDates:true});
          resolve(wb);
        }catch(err){
          reject(err);
        }
      };
      reader.onerror = err => reject(err);
      reader.readAsArrayBuffer(file);
    });
  }

  // ①側：号室を正規化（1F, 201, 202203, 301302303, 701702 など）
  function normalizeRoomFromBill(value){
    if(value === null || value === undefined) return null;
    let s = String(value).trim();
    if(!s) return null;
    s = s.replace(/\s+/g,'');          // 改行などを削除
    s = s.replace(/[^0-9F]/g,'');      // 数字とFだけ残す
    if(!s) return null;
    return s;
  }

  // ②側：「三光ﾋﾞﾙ1F」→1F、「三光ﾋﾞﾙ202・203」→202203、「三光ﾋﾞﾙ3F」→301302303 など
  function normalizeRoomFromFX(name){
    if(name === null || name === undefined) return null;
    let s = String(name).trim();
    s = s.replace(/^三光ﾋﾞﾙ/,'');
    s = s.replace(/^三光ビル/,'');
    s = s.replace(/\s+/g,'');
    s = s.replace(/[^0-9F]/g,'');
    if(s === '3F' || s === '3'){
      // 301・302・303 の合算行
      return '301302303';
    }
    if(!s) return null;
    return s;
  }

  // Excelシリアル値→Date（念のためフォロー）
  function excelSerialToDate(serial){
    const excelEpoch = new Date(Date.UTC(1899, 11, 30)); // 1899-12-30
    const ms = serial * 24 * 60 * 60 * 1000;
    return new Date(excelEpoch.getTime() + ms);
  }

  // ①のブックから「請求日」と「号室別請求金額マップ」を取得
  function parseInvoiceWorkbook(wb){
    const sheetName = wb.SheetNames.find(n => n.indexOf('三光ビル賃貸料') !== -1) || wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const aoa = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
    if(!aoa.length){
      throw new Error('①のシートが空です。');
    }

    // 「請求金額」ヘッダーの位置を検出
    let amountCol = null;
    let headerRowIndex = null;
    for(let r=0; r<aoa.length; r++){
      const row = aoa[r] || [];
      for(let c=0; c<row.length; c++){
        if(row[c] === '請求金額'){
          amountCol = c;
          headerRowIndex = r;
          break;
        }
      }
      if(amountCol !== null) break;
    }
    if(amountCol === null){
      throw new Error('①側で「請求金額」ヘッダーが見つかりません。テンプレートの行・列を確認してください。');
    }

    // 「≪請求日≫」の右隣を請求日として取得
    let invoiceDate = null;
    for(let r=0; r<aoa.length; r++){
      const row = aoa[r] || [];
      for(let c=0; c<row.length; c++){
        if(row[c] === '≪請求日≫'){
          const v = row[c+1];
          if(v instanceof Date){
            invoiceDate = v;
          }else if(typeof v === 'number'){
            invoiceDate = excelSerialToDate(v);
          }else if(v){
            // 文字列など
            invoiceDate = new Date(v);
          }
          break;
        }
      }
      if(invoiceDate) break;
    }
    if(!invoiceDate){
      log('注意：①側で請求日が見つかりませんでした。②側の「月日」は上書きしません。');
    }

    // 号室→請求金額（税込）マップを作成
    const roomAmounts = {};
    for(let r = headerRowIndex + 1; r < aoa.length; r++){
      const row = aoa[r] || [];
      const room = row[0];
      const amount = row[amountCol];
      if(room === null || room === undefined || room === '') continue;
      if(typeof amount !== 'number') continue;
      const key = normalizeRoomFromBill(room);
      if(!key) continue;
      roomAmounts[key] = amount;
    }

    return { sheetName, invoiceDate, roomAmounts };
  }

  // ②側を更新
  function updateFXWorkbook(wb, roomAmounts, invoiceDate){
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const aoa = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
    if(!aoa.length){
      throw new Error('②のシートが空です。');
    }
    const header = aoa[0] || [];

    function findCol(title){
      const idx = header.indexOf(title);
      if(idx === -1){
        throw new Error('②側でヘッダー「' + title + '」が見つかりません。');
      }
      return idx;
    }

    const colDate      = findCol('月日');
    const colAcctName  = findCol('借方口座名');
    const colDrAmount  = findCol('借方取引金額');
    const colCrAmount  = findCol('貸方取引金額');
    const colCrTax     = findCol('貸方消費税等');
    const colCrNet     = findCol('貸方税抜き金額');

    let updatedCount = 0;
    const missing = [];

    for(let r=1; r<aoa.length; r++){
      const row = aoa[r] || [];
      const name = row[colAcctName];
      const key = normalizeRoomFromFX(name);
      if(!key) continue;

      const amount = roomAmounts[key];
      if(amount === undefined){
        missing.push({ row: r+1, name: name, key: key });
        continue;
      }

      // 日付を上書き（見つかった場合のみ）
      if(invoiceDate){
        row[colDate] = invoiceDate;
      }

      // 金額
      row[colDrAmount] = amount;
      row[colCrAmount] = amount;
      const net = Math.round(amount / 1.1);
      const tax = amount - net;
      row[colCrNet] = net;
      row[colCrTax] = tax;

      updatedCount++;
      aoa[r] = row;
    }

    const newWs = XLSX.utils.aoa_to_sheet(aoa);
    const outWb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(outWb, newWs, sheetName);

    return { workbook: outWb, updatedCount, missing };
  }

  runBtn.addEventListener('click', async () => {
    clearLog();
    resultWorkbook = null;
    downloadBtn.disabled = true;

    const file1 = file1Input.files[0];
    const file2 = file2Input.files[0];

    if(!file1 || !file2){
      log('①と②の両方のファイルを選択してください。');
      return;
    }

    try{
      log('①ファイルを読み込み中…');
      const wb1 = await loadWorkbook(file1);
      log('②ファイルを読み込み中…');
      const wb2 = await loadWorkbook(file2);

      log('①から請求日と号室別請求金額を抽出します…');
      const invoiceInfo = parseInvoiceWorkbook(wb1);
      const roomKeys = Object.keys(invoiceInfo.roomAmounts);
      log(`抽出したテナント数：${roomKeys.length}件`);

      if(invoiceInfo.invoiceDate){
        const d = invoiceInfo.invoiceDate;
        const dStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        log(`請求日：${dStr}`);
      }

      log('②へ転記処理を実行します…');
      const result = updateFXWorkbook(wb2, invoiceInfo.roomAmounts, invoiceInfo.invoiceDate);

      log(`更新した仕訳行数：${result.updatedCount}行`);

      if(result.missing.length){
        log('①に対応する金額が見つからなかった行（要確認）：');
        result.missing.forEach(m => {
          log(`  行${m.row} 借方口座名=${m.name} （キー=${m.key}）`);
        });
      }else{
        log('全ての「借方口座名」について①側の金額が見つかりました。');
      }

      resultWorkbook = result.workbook;
      downloadBtn.disabled = false;
      log('処理が完了しました。「結果をダウンロード」ボタンから保存できます。');

    }catch(err){
      console.error(err);
      log('エラーが発生しました：' + err.message);
    }
  });

  downloadBtn.addEventListener('click', () => {
    if(!resultWorkbook) return;
    const wbout = XLSX.write(resultWorkbook, {bookType:'xlsx', type:'array'});
    const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'FX連携用_三光ビル_更新済み.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

})();
</script>
</body>
</html>
