<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CCC計算ツール</title>
<link rel="icon" href="favicon192192.png" />
<style>
  :root{
    --brand:#578899; --ink:#222; --muted:#666; --bg:#f7f9fb; --card:#fff; --line:#e6eef3;
    --dio:#5AA47A;  /* DIO（緑） */
    --dso:#EFB660;  /* DSO（橙） */
    --dpo:#447EA6;  /* DPO（濃い青） */
    --ccc:#2F6E8D;  /* CCC（やや濃い青） */
    --rest:#EEF3F7; /* 余白部（薄） */
  }
  *{box-sizing:border-box}
  html,body{background:#f7f9fb;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"ヒラギノ角ゴ ProN","Noto Sans JP",sans-serif}
  main{max-width:980px;margin:18px auto;padding:0 12px 96px}

  .title{display:flex;align-items:center;gap:12px;margin-bottom:10px;padding:8px 4px}
  .title img{height:42px}
  .title h1{margin:0;font-size:clamp(18px,3.5vw,22px);line-height:1.15}
  .title .spacer{flex:1}
  .btn-link{
    display:inline-block;user-select:none;text-decoration:none;padding:6px 12px;line-height:1;font-size:13px;font-weight:700;
    color:var(--brand);background:#fff;border-radius:12px;border:1.5px solid color-mix(in oklab,var(--brand),white 30%);box-shadow:0 0 0 1px #dfe7ee inset;
  }

  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
  .card h2{font-size:16px;margin:0 0 10px;color:var(--brand)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  label{font-size:13px;color:var(--muted);display:block;margin:6px 0 4px}
  input[type="text"]{width:100%;padding:10px 12px;border:1px solid #cfd9e3;border-radius:10px;font-size:16px}
  input[type="text"]:focus{outline:2px solid color-mix(in oklab,var(--brand),white 70%)}

  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:2px solid var(--brand);padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer;user-select:none;background:#fff}
  .chip[data-active="true"]{background:var(--brand);color:#fff;font-weight:700}
  .badge{display:inline-block;border:1px solid var(--brand);border-radius:999px;padding:4px 8px;font-size:12px;background:#fff}
  .badge.fill{background:var(--brand);color:#fff}
  .sub{font-size:12px;color:var(--muted)}

  /* KPI（CCCは右端・強調） */
  .kpi{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
  @media (max-width:900px){.kpi{grid-template-columns:1fr 1fr}}
  .metric{border:1px dashed #d7e2ea;border-radius:12px;padding:12px}
  .metric .name{font-size:12px;color:var(--muted)}
  .metric .value{font-size:24px;font-weight:800;margin-top:4px}
  #mDIO .value{color:var(--dio)} #mDSO .value{color:var(--dso)} #mDPO .value{color:var(--dpo)}
  #mCCC{border:2px solid var(--ccc);box-shadow:0 0 0 3px color-mix(in oklab,var(--ccc),white 70%) inset;background:linear-gradient(180deg,#f8fbff 0%,#ffffff 100%)}
  #mCCC .value{color:var(--ccc);font-size:32px}

  /* グラフ（太め・密着・四角・印刷色維持） */
  .flow{margin-top:12px;-webkit-print-color-adjust:exact; print-color-adjust: exact; color-adjust: exact;}
  .rail{position:relative;height:44px;background:var(--rest)}
  .rail + .rail{margin-top:2px}
  .seg{position:absolute;top:0;left:0;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:14px}
  .seg-dio{background:var(--dio)}
  .seg-dso{background:var(--dso)}
  .seg-dpo{background:var(--dpo)}
  .seg-ccc{background:var(--ccc)}
  .rest-right,.rest-left{position:absolute;top:0;bottom:0;background:#FAFCFE}
  .rest-right{right:0} .rest-left{left:0}

  .btn-card{display:flex;flex-wrap:wrap;gap:8px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  button{cursor:pointer;border:1px solid #d7e2ea;background:#fff;padding:9px 12px;border-radius:10px;font-size:14px}
  button.primary{background:var(--brand);border-color:var(--brand);color:#fff}

  .impact-box{
    margin-top:10px;padding:8px 10px;border-radius:10px;
    border:1px dashed #d7e2ea;background:#f9fbff;font-size:12px;color:var(--muted);
  }

  footer.mk-mini{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line);padding:10px 12px;font-size:12px;color:#334}
  .mk-mini .mini-line{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;line-height:1.6}
  .mk-mini a{color:var(--brand);text-decoration:underline}
  .mk-mini .sep{opacity:.6}

  @media print{ .title, .btn-card{display:none} main{padding-bottom:16px} }
</style>
</head>
<body>
<main>
  <!-- タイトル -->
  <div class="title">
    <img src="ロゴ.jpg" alt="松本会計" />
    <h1>CCC（キャッシュ・コンバージョン・サイクル）計算ツール</h1>
    <div class="spacer"></div>
    <a class="btn-link" href="CCC.png" target="_blank" rel="noopener">解説</a>
  </div>

  <!-- STEP0: 期間日数・入力モードの選択 -->
  <div class="card" id="intro">
    <h2>STEP0 期間日数と入力方法</h2>
    <div class="chips" id="modeChips">
      <span class="chip" data-value="direct" data-active="true">① DIO/DSO/DPOを直接入力</span>
      <span class="chip" data-value="auto">② 財務数値から自動算出</span>
    </div>
    <div class="chips" id="daysChips" style="margin-top:8px">
      <span class="chip" data-days="365" data-active="true">期間日数 365</span>
      <span class="chip" data-days="360">360</span>
      <span class="badge" id="presetCCC">業種平均CCC：— 日</span>
    </div>
    <p class="sub">CCC＝DIO＋DSO－DPO。DIO＝棚卸資産÷（売上原価÷日数）、DSO＝売上債権÷（売上高÷日数）、DPO＝仕入債務÷（売上原価÷日数）。</p>
  </div>

  <!-- STEP1: 業種選択 -->
  <div class="card" id="presets">
    <h2>STEP1 業種を選択</h2>
    <p class="sub">まず比較の基準となる業種を選びます。初期値として「全産業」を選択しています。</p>
    <div class="chips" id="industryChips" role="tablist" aria-label="業種プリセット"></div>
    <p class="sub" style="margin-top:8px">
      ※各業種プリセットは令和7年版TKC経営指標（BAST）を元に計算しています。原表は365日基準のため、360日選択時は比例換算します。
    </p>
  </div>

  <!-- STEP2-A: 自社のCCC入力（直接） -->
  <div class="card" id="directBox">
    <h2>STEP2-A 自社のDIO/DSO/DPOを直接入力</h2>
    <div class="row">
      <div><label>DIO（在庫回転期間）</label><input type="text" inputmode="decimal" placeholder="例）60.5" id="dioInput"></div>
      <div><label>DSO（売上債権回転期間）</label><input type="text" inputmode="decimal" placeholder="例）30.2" id="dsoInput"></div>
      <div><label>DPO（仕入債務回転期間）</label><input type="text" inputmode="decimal" placeholder="例）40.0" id="dpoInput"></div>
    </div>
    <p class="sub">業種チップをクリックすると、その業種の平均DIO/DSO/DPOを初期値として流し込めます。そこから自社の実態に合わせて調整してください。</p>
  </div>

  <!-- STEP2-B: 自動算出 -->
  <div class="card" id="autoBox" style="display:none">
    <h2>STEP2-B 財務数値から自社のDIO/DSO/DPOを自動算出</h2>
    <div class="row">
      <div><label>売上高（期間合計／円）</label><input type="text" inputmode="numeric" placeholder="例）239,874,000" id="sales"></div>
      <div><label>売上原価（期間合計／円）</label><input type="text" inputmode="numeric" placeholder="例）164,617,000" id="cogs"></div>
      <div><label>売上債権（平均／円）</label><input type="text" inputmode="numeric" placeholder="例）28,425,000" id="ar"></div>
      <div><label>棚卸資産（平均／円）</label><input type="text" inputmode="numeric" placeholder="例）20,315,000" id="inv"></div>
      <div><label>仕入債務（平均／円）</label><input type="text" inputmode="numeric" placeholder="例）18,069,000" id="ap"></div>
    </div>
    <p class="sub">元帳や試算表から「期間合計の売上高・売上原価」と「平均残高」を投入すると、自社のDIO/DSO/DPOを自動計算します。</p>
  </div>

  <!-- STEP3: 資金負担インパクト（任意） -->
  <div class="card" id="impactInputs">
    <h2>STEP3 CCC短縮による資金負担インパクト（任意）</h2>
    <div class="row">
      <div><label>年間売上高（円）</label><input type="text" inputmode="numeric" placeholder="例）300,000,000" id="impactSales"></div>
      <div><label>限界利益率（％）</label><input type="text" inputmode="decimal" placeholder="例）40" id="marginRate"></div>
    </div>
    <p class="sub">選択した業種の平均CCCと自社CCCの差（Δ日）をもとに、CCCを業種平均まで短縮できた場合に、平常時に必要な運転資金の平均残高がどれだけ少なくて済むかをざっくり試算します。算式：年間売上高×(1−限界利益率)÷365×Δ日。</p>
  </div>

  <!-- 結果 -->
  <div class="card" id="result">
    <h2>結果（CCCと業種平均の比較）</h2>
    <div class="kpi">
      <div class="metric" id="mDIO"><div class="name">DIO（在庫回転期間）</div><div class="value" id="vDIO">— 日</div></div>
      <div class="metric" id="mDSO"><div class="name">DSO（売上債権回転期間）</div><div class="value" id="vDSO">— 日</div></div>
      <div class="metric" id="mDPO"><div class="name">DPO（仕入債務回転期間）</div><div class="value" id="vDPO">— 日</div></div>
      <div class="metric" id="mCCC"><div class="name">CCC</div><div class="value" id="vCCC">— 日</div></div>
    </div>

    <!-- グラフ -->
    <div class="flow" id="flow">
      <div class="rail" id="railTop">
        <span class="seg seg-dio" id="gDIO">在庫回転期間 — 日</span>
        <span class="seg seg-dso" id="gDSO">売上債権回転期間 — 日</span>
      </div>
      <div class="rail" id="railMid">
        <span class="seg seg-dpo" id="gDPO">仕入債務回転期間 — 日</span>
        <span class="rest-right" id="restRight" style="width:100%"></span>
      </div>
      <div class="rail" id="railBot">
        <span class="rest-left" id="restLeft" style="width:100%"></span>
        <span class="seg seg-ccc" id="gCCC">CCC — 日</span>
      </div>
    </div>

    <p class="sub" id="comment">入力すると自動計算します（単位：日）。CCCが小さいほど運転資金効率は良好。負の場合は仕入先信用で回っている状態です。</p>

    <!-- インパクト表示 -->
    <div class="impact-box">
      <p class="sub" id="impactSummary">
        業種（初期値は「全産業」）と自社CCCを入力すると、業種平均とのギャップと、CCCを業種平均まで短縮した場合に平常時に必要な運転資金の平均残高がどれだけ少なくて済むかを表示します。
      </p>
    </div>
  </div>

  <div class="btn-card">
    <button class="primary" id="copyBtn" type="button">結果をコピー</button>
    <button id="resetBtn" type="button">リセット</button>
    <button id="printBtn" type="button">印刷 / PDF保存</button>
    <button id="csvBtn" type="button">CSV</button>
  </div>

  <div id="terms" aria-hidden="true" style="display:none"></div>
</main>

<footer class="mk-mini">
  <div class="mini-line">
    © <span id="cpy-year"></span>
    <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener">税理士法人松本会計事務所</a>
    <span class="sep">｜</span>
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ja" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a>
    <span class="sep">｜</span>
    <a href="#terms">利用条件</a>
    <span class="sep">｜</span>
    <span id="rnum"></span>
    <span>（<span id="lastmod"></span>）</span>
  </div>
</footer>

<script>
(function(){
  /* バージョン（今回 r22） */
  const RNUM = 'r22';
  const ORIGIN_DAYS = 365; // BAST原表の基準日数

  const nfInt   = new Intl.NumberFormat('ja-JP');
  const nf1     = new Intl.NumberFormat('ja-JP',{maximumFractionDigits:1,minimumFractionDigits:0});
  const nf1flex = new Intl.NumberFormat('ja-JP',{maximumFractionDigits:1});
  const $  = s=>document.querySelector(s);
  const $$ = s=>document.querySelectorAll(s);

  // 初期業種は「全産業」を前提
  const state = {
    mode:'direct',
    days:365,
    currentIndustry:'全産業',
    ccc:0
  };

  // 年・r番号・更新日
  (function(){
    const d = new Date(document.lastModified || Date.now());
    $('#cpy-year').textContent = d.getFullYear();
    $('#rnum').textContent = RNUM;
    $('#lastmod').textContent = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  })();

  /* ▼ R7 BAST（日数プリセット） */
  const PRESETS_DAYS = {
    "全産業":{"dio":30.9,"dso":43.3,"dpo":50.4},
    "漁業":{"dio":70.6,"dso":16.1,"dpo":94.5},
    "建設業":{"dio":40.8,"dso":44.6,"dpo":54.2},
    "製造業":{"dio":45.5,"dso":61.4,"dpo":65.5},
    "卸売業":{"dio":27.1,"dso":50.4,"dpo":53.6},
    "小売業":{"dio":31.8,"dso":23.4,"dpo":32.8},
    "宿泊業":{"dio":5.0,"dso":17.1,"dpo":41.6},
    "飲食業":{"dio":6.9,"dso":11.1,"dpo":31.7}
  };

  /* ユーティリティ */
  function digits(s){return (s||'').replace(/[^\d.-]/g,'');}
  function parseNum(s){
    const t = digits(s);
    if(t===''||t==='-'||t==='.'||t==='-.') return NaN;
    return Number(t);
  }
  function valNum(id){
    const el = $('#'+id);
    if(!el) return 0;
    const v = parseNum(el.value);
    return isNaN(v)?0:v;
  }

  /* 小数入力（DIO/DSO/DPO・限界利益率）：入力中自由、blurで丸め */
  function attachDecimalHandlers(el, maxDecimals=1){
    if(!el) return;
    el.dataset.prev = el.value || '';
    const re = new RegExp(`^-?\\d*(?:\\.\\d{0,${maxDecimals}})?$`);
    el.addEventListener('input', ()=>{
      const v = el.value;
      if (v === '' || re.test(v)) {
        el.dataset.prev = v;
        calc(); updateImpact();
      } else {
        el.value = el.dataset.prev || '';
      }
    });
    el.addEventListener('blur', ()=>{
      const n = parseFloat(el.value);
      if (!isNaN(n)) el.value = n.toFixed(maxDecimals);
      calc(); updateImpact();
    });
  }

  /* 金額入力（千分位フォーマット維持） */
  function keepFormatInt(el){
    const raw = el.value;
    const start = el.selectionStart || raw.length;
    const leftDigits = raw.slice(0,start).replace(/[^\d]/g,'').length;
    let val = parseNum(raw); if(isNaN(val)) val = '';
    const formatted = (val===''? '' : nfInt.format(Math.trunc(val)));
    el.value = formatted;
    let pos=0, seen=0;
    for(let i=0;i<formatted.length;i++){
      if(/\d/.test(formatted[i])) seen++;
      if(seen>=leftDigits){pos=i+1;break;}
    }
    el.setSelectionRange(pos,pos);
  }

  /* モード切替 */
  $$('#modeChips .chip').forEach(ch=>{
    ch.addEventListener('click',()=>{
      $$('#modeChips .chip').forEach(c=>c.dataset.active="false");
      ch.dataset.active="true";
      state.mode=ch.dataset.value;
      $('#directBox').style.display = state.mode==='direct'?'block':'none';
      $('#autoBox').style.display   = state.mode==='auto'  ?'block':'none';
      calc(); updateImpact();
    });
  });

  /* 日数切替 */
  $$('#daysChips .chip').forEach(ch=>{
    if(!ch.dataset.days) return;
    ch.addEventListener('click',()=>{
      $$('#daysChips .chip').forEach(c=>c.dataset.active="false");
      ch.dataset.active="true";
      state.days = Number(ch.dataset.days)||365;
      renderIndustryChips();
      updatePresetBadge();
      calc();
      updateImpact();
    });
  });

  /* 業種選択処理 */
  function selectIndustry(name, prefill){
    const base = PRESETS_DAYS[name];
    if(!base) return;
    state.currentIndustry = name;

    // チップの見た目更新
    $$('#industryChips .chip').forEach(ch=>{
      ch.dataset.active = (ch.dataset.name === name) ? "true" : "false";
    });

    const factor = state.days / ORIGIN_DAYS;

    if(prefill){
      const dio = base.dio * factor;
      const dso = base.dso * factor;
      const dpo = base.dpo * factor;
      // 直接入力モードにして初期値として流し込む
      $$('#modeChips .chip').forEach(c=>c.dataset.active="false");
      $('#modeChips .chip[data-value="direct"]').dataset.active="true";
      state.mode='direct';
      $('#autoBox').style.display='none';
      $('#directBox').style.display='block';
      $('#dioInput').value = dio.toFixed(1);
      $('#dsoInput').value = dso.toFixed(1);
      $('#dpoInput').value = dpo.toFixed(1);
    }

    updatePresetBadge();
    calc();
    updateImpact();
  }

  /* 業種チップ描画（BAST日数→比較用＋必要なら初期値に） */
  function renderIndustryChips(){
    const wrap = $('#industryChips');
    wrap.innerHTML='';
    const factor = state.days / ORIGIN_DAYS; // 360対応：比例換算
    Object.entries(PRESETS_DAYS).forEach(([name,p])=>{
      const dio = p.dio * factor, dso = p.dso * factor, dpo = p.dpo * factor;
      const ccc = dio + dso - dpo;
      const chip = document.createElement('span');
      chip.className='chip';
      chip.dataset.name = name;
      if(name === state.currentIndustry) chip.dataset.active = "true";
      chip.textContent = `${name}：${nf1flex.format(ccc)}日`;
      chip.title = `DIO ${dio.toFixed(1)}日 / DSO ${dso.toFixed(1)}日 / DPO ${dpo.toFixed(1)}日`;
      chip.addEventListener('click',()=>selectIndustry(name, true));
      wrap.appendChild(chip);
    });
  }

  /* 上部バッジ更新（常に「選択業種の平均CCC」） */
  function updatePresetBadge(){
    const badge = $('#presetCCC');
    const base = PRESETS_DAYS[state.currentIndustry];
    if(!base){
      badge.textContent = '業種平均CCC：— 日';
      badge.classList.remove('fill');
      return;
    }
    const factor = state.days / ORIGIN_DAYS;
    const dio = base.dio * factor;
    const dso = base.dso * factor;
    const dpo = base.dpo * factor;
    const cccAvg = dio + dso - dpo;
    badge.textContent = `業種平均CCC：${nf1flex.format(cccAvg)} 日`;
    badge.classList.remove('fill');
  }

  /* 入力監視 */
  attachDecimalHandlers($('#dioInput'), 1);
  attachDecimalHandlers($('#dsoInput'), 1);
  attachDecimalHandlers($('#dpoInput'), 1);
  attachDecimalHandlers($('#marginRate'), 1);

  ['sales','cogs','ar','inv','ap','impactSales'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input',()=>{ keepFormatInt(el); calc(); updateImpact(); });
    el.addEventListener('blur', ()=>{ keepFormatInt(el); calc(); updateImpact(); });
  });

  /* グラフ更新 */
  function drawBars(dio,dso,dpo,ccc){
    const max = Math.max(10, dio+dso, dpo, Math.abs(ccc));

    const pDIO = dio/max*100, pDSO = dso/max*100;
    $('#gDIO').style.left = '0%';
    $('#gDIO').style.width = pDIO+'%';
    $('#gDSO').style.left = pDIO+'%';
    $('#gDSO').style.width = pDSO+'%';
    $('#gDIO').textContent = `在庫回転期間 ${dio?nf1.format(dio):'—'} 日`;
    $('#gDSO').textContent = `売上債権回転期間 ${dso?nf1.format(dso):'—'} 日`;

    const pDPO = dpo/max*100;
    $('#gDPO').style.left = '0%';
    $('#gDPO').style.width = pDPO+'%';
    $('#gDPO').textContent = `仕入債務回転期間 ${dpo?nf1.format(dpo):'—'} 日`;
    $('#restRight').style.left = pDPO+'%';
    $('#restRight').style.width = (100-pDPO)+'%';

    const cLeft = Math.max(dpo,0)/max*100;
    const cWidth= Math.max(ccc,0)/max*100;
    $('#restLeft').style.width = cLeft+'%';
    $('#gCCC').style.left = cLeft+'%';
    $('#gCCC').style.width= cWidth+'%';
    $('#gCCC').textContent = `CCC ${ (dio||dso||dpo) ? nf1.format(ccc) : '—'} 日`;
  }

  /* 計算 */
  function calc(){
    let dio=0,dso=0,dpo=0, ccc=0;
    const days = state.days;

    if(state.mode==='direct'){
      dio = Math.max(0, parseFloat($('#dioInput').value) || 0);
      dso = Math.max(0, parseFloat($('#dsoInput').value) || 0);
      dpo = Math.max(0, parseFloat($('#dpoInput').value) || 0);
    }else{
      const sales = valNum('sales'), cogs = valNum('cogs');
      const ar=valNum('ar'), inv=valNum('inv'), ap=valNum('ap');
      dso = (sales>0 && ar>=0) ? (ar/sales)*days : 0;
      dio = (cogs>0  && inv>=0) ? (inv/cogs)*days  : 0;
      dpo = (cogs>0  && ap>=0 ) ? (ap/cogs )*days  : 0;
    }
    ccc = dio + dso - dpo;
    state.ccc = ccc;

    $('#vDIO').textContent = (dio? nf1.format(dio):'—')+' 日';
    $('#vDSO').textContent = (dso? nf1.format(dso):'—')+' 日';
    $('#vDPO').textContent = (dpo? nf1.format(dpo):'—')+' 日';
    $('#vCCC').textContent = ((dio||dso||dpo)? nf1.format(ccc):'—')+' 日';

    drawBars(Math.max(dio,0), Math.max(dso,0), Math.max(dpo,0), (dio+dso-dpo));

    const msg = (dio||dso||dpo)
      ? (ccc<=0 ? `CCC＝${nf1.format(ccc)}日：仕入先信用（DPO）が回収（DIO+DSO）を上回り、持ち出し無し。`
                : `CCC＝${nf1.format(ccc)}日：支払から回収まで平均${nf1.format(ccc)}日を要します。`)
      : '入力すると自動計算します。CCCが小さいほど良好で、負の場合は仕入先信用で回っています。';
    $('#comment').textContent = msg;
  }

  /* 資金負担インパクトの更新 */
  function parseMarginRate(){
    const raw = parseNum($('#marginRate')?.value || '');
    if(isNaN(raw)) return NaN;
    if(raw>1) return raw/100;   // 40 → 0.4 と解釈
    return raw;                 // 0.4 → 0.4
  }

  function updateImpact(){
    const el = $('#impactSummary');
    if(!el) return;

    const cccSelf = state.ccc;
    const base = PRESETS_DAYS[state.currentIndustry];

    if(!(cccSelf>0)){
      el.textContent = '自社のCCCを計算すると、選択業種の平均CCCとのギャップと、CCCを業種平均まで短縮した場合に平常時に必要な運転資金の平均残高がどれだけ少なくて済むかを表示します。';
      return;
    }
    if(!base){
      el.textContent = `自社CCCは約${nf1.format(cccSelf)}日です。業種を選択すると、業種平均との比較と、平常時に必要な運転資金の平均残高がどれだけ少なくて済むかの目安を試算します。`;
      return;
    }

    const factor = state.days / ORIGIN_DAYS;
    const dioAvg = base.dio * factor;
    const dsoAvg = base.dso * factor;
    const dpoAvg = base.dpo * factor;
    const cccAvg = dioAvg + dsoAvg - dpoAvg;

    const delta = cccSelf - cccAvg; // 自社−業種平均
    const headLine = `選択業種「${state.currentIndustry}」の平均CCC：約${nf1.format(cccAvg)}日 / 自社：約${nf1.format(cccSelf)}日（Δ日＝${nf1.format(delta)}日）`;

    if(delta <= 0){
      el.textContent = headLine + '。既に業種平均以下のCCCのため、この指標ベースでは追加で「短縮して浮く運転資金」はありません。';
      return;
    }

    // 売上高と限界利益率
    let S = valNum('impactSales');
    if(!S) S = valNum('sales'); // 自動算出の売上高を代用可

    const m = parseMarginRate();
    if(!(S>0) || isNaN(m) || !(m>0 && m<1)){
      el.textContent = headLine + '。年間売上高と限界利益率（0〜100%）を入力すると、CCCを業種平均まで短縮した場合に、平常時に必要な運転資金の平均残高がどれだけ少なくて済むかの目安を表示します。';
      return;
    }

    const V = S * (1 - m);                 // 年間変動費（ざっくり）
    const impact = V / 365 * delta;        // 年間変動費×Δ日÷365
    const impactMan = impact / 10000;

    el.textContent = headLine +
      `。このとき、CCCを業種平均まで短縮できれば、平常時に必要な運転資金の平均残高が、ざっくり「約${nf1flex.format(impactMan)}万円」少なくて済む計算になります（式：年間売上高×(1−限界利益率)÷365×Δ日）。`;
  }

  /* ボタン */
  $('#copyBtn').addEventListener('click',()=>{
    const text = [
      '【CCC結果】',
      `DIO（在庫回転期間）：${$('#vDIO').textContent}`,
      `DSO（売上債権回転期間）：${$('#vDSO').textContent}`,
      `DPO（仕入債務回転期間）：${$('#vDPO').textContent}`,
      `CCC：${$('#vCCC').textContent}`,
      `(日数基準：${state.days}日 / 入力モード：${state.mode==='direct'?'直接入力':'自動算出'} / 業種：${state.currentIndustry||'—'})`
    ].join('\n');
    navigator.clipboard.writeText(text).then(()=>alert('結果をコピーしました'));
  });

  $('#resetBtn').addEventListener('click',()=>{
    $$('input[type="text"]').forEach(el=>{ el.value=''; });
    state.currentIndustry='全産業';
    state.ccc = 0;
    renderIndustryChips();
    updatePresetBadge();
    calc();
    updateImpact();
    window.scrollTo({top:0,behavior:'smooth'});
  });

  $('#printBtn').addEventListener('click',()=>window.print());

  $('#csvBtn').addEventListener('click',()=>{
    const rows = [
      ['指標','値'],
      ['DIO（日）', $('#vDIO').textContent.replace(' 日','')],
      ['DSO（日）', $('#vDSO').textContent.replace(' 日','')],
      ['DPO（日）', $('#vDPO').textContent.replace(' 日','')],
      ['CCC（日）', $('#vCCC').textContent.replace(' 日','')],
      ['日数基準',  state.days],
      ['業種',       state.currentIndustry||'']
    ];
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'ccc_result.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // 初期化：業種「全産業」を前提に描画
  renderIndustryChips();
  updatePresetBadge();
  calc();
  updateImpact();
})();
</script>
</body>
</html>
